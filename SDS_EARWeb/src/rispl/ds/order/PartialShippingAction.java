package rispl.ds.order;

import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.struts2.interceptor.validation.SkipValidation;

import rispl.dkart.services.ejb.transaction.OrderTransactionsIfc;
import rispl.dkart.services.entities.transaction.OrderTranHeader;
import rispl.ds.DSAction;
import rispl.ds.context.DKartContext;

public class PartialShippingAction extends DSAction {
	private static final long serialVersionUID = 1L;
	private static final Logger LOGGER = LogManager.getLogger(PartialShippingAction.class);

	private String orderId;
	private OrderTranHeader ord_tran_header;
	
	OrderTranHeader orderInit, orderPartial, orderCancel;
	// Saideep: For the order inprogress Orders
	private boolean inProgressStatus;
	// Saideep: to check if partial shipping is available for the order
	private boolean partialShippingAvailable;
	// Saideep: to show item details in partial ship popup modal dialog
	private Map<String, List<String>> itemsShipped, itemsNotShipped;
	// Return reason codes
	private String partialShippingReasonCode;

	public String partialShipping() {
		if (getFromSession(SESSION.ORDER_TRANHEADER) instanceof OrderTranHeader)
			setOrd_tran_header((OrderTranHeader) getFromSession(SESSION.ORDER_TRANHEADER));
		try {
			LOGGER.info("Check for partial Shippping");
			checkForPartialShipping();
		} catch (Exception e) {
			return ERROR;
		}
		if (!partialShippingAvailable) {
			addActionError("Partial Shipping is not available for this order.");
			return ERROR;
		}

		try {
			OrderTransactionsIfc tran = DKartContext.getLookupOrder();
			Map<String, OrderTranHeader> partialProcessedTransactionMap = tran.processPartialShipping(orderId, partialShippingReasonCode, getEmployee().getEmployeeId());
			orderInit = partialProcessedTransactionMap.get("orderInit");
			orderPartial = partialProcessedTransactionMap.get("orderPartial");
			orderCancel = partialProcessedTransactionMap.get("orderCancel");
			
			
		} catch (Exception e) {
			addActionError(e.getMessage());
			LOGGER.error(e.getMessage(), e.getCause());
		}
		
		if(orderPartial==null || orderCancel == null)
		{
			addActionError("An error occured while processing partial shipment!");
			addActionError("Order Partial Or Order Cancel could not be saved.");
			return ERROR;
		}
		
		addActionMessage("Partial Shipment has been processed successfully.");
		return SUCCESS;

	}
	
	public String inProgressOrderReopen() {
		if (getFromSession(SESSION.ORDER_TRANHEADER) instanceof OrderTranHeader)
			setOrd_tran_header((OrderTranHeader) getFromSession(SESSION.ORDER_TRANHEADER));
		try {
			LOGGER.info("Check for Inprogress Order");
			if (ord_tran_header != null) {
				String orderId = ord_tran_header.getOrdTranSum().getIdOrd();
				OrderTransactionsIfc tran = DKartContext.getLookupOrder();
				inProgressStatus = tran.inProgressOrder(orderId);
			}
		} catch (Exception e) {
			return ERROR;
		}
		
		addActionMessage("In Progress Order has been processed successfully Reopen in WMS.");
		return SUCCESS;

	}

	
	
	
	

	protected void checkForPartialShipping() throws Exception {
		if (ord_tran_header != null) {
			String orderId = ord_tran_header.getOrdTranSum().getIdOrd();
			OrderTransactionsIfc tran = DKartContext.getLookupOrder();
			partialShippingAvailable = tran.isPartialShippingAvailable(orderId);
			LOGGER.info("For Order Id: {} partial shipping available: {}", orderId, partialShippingAvailable);
		}
	}

	@SuppressWarnings({ "unchecked", "rawtypes" })
	protected void getShippingDetails() throws Exception {
		if (ord_tran_header != null) {
			String orderId = ord_tran_header.getOrdTranSum().getIdOrd();
			itemsShipped = new LinkedHashMap<String, List<String>>();
			itemsNotShipped = new LinkedHashMap<String, List<String>>();

			OrderTransactionsIfc tran = DKartContext.getLookupOrder();
			Map<String, Map> shippingDetailsMap = tran.getShippingDetails(orderId);
			if (shippingDetailsMap != null && !shippingDetailsMap.isEmpty()) {
				if (shippingDetailsMap.containsKey("itemsShipped"))
					itemsShipped = shippingDetailsMap.get("itemsShipped");
				if (shippingDetailsMap.containsKey("itemsNotShipped"))
					itemsNotShipped = shippingDetailsMap.get("itemsNotShipped");
			}
			LOGGER.info("For Order Id: "+orderId+" Items shipped are: \n\t"+itemsShipped);
			LOGGER.info("For Order Id: "+orderId+" Items not shipped are: \n\t"+itemsNotShipped);
		}
	}

	public boolean getPartialShippingAvailable() {
		return partialShippingAvailable;
	}

	public void setPartialShippingAvailable(boolean partialShippingAvailable) {
		this.partialShippingAvailable = partialShippingAvailable;
	}

	public OrderTranHeader getOrd_tran_header() {
		return ord_tran_header;
	}

	public void setOrd_tran_header(OrderTranHeader ord_tran_header) {
		this.ord_tran_header = ord_tran_header;
	}

	public String getOrderId() {
		return orderId;
	}

	public void setOrderId(String orderId) {
		this.orderId = orderId;
	}

	public Map<String, List<String>> getItemsShipped() {
		return itemsShipped;
	}

	public void setItemsShipped(Map<String, List<String>> itemsShipped) {
		this.itemsShipped = itemsShipped;
	}

	public Map<String, List<String>> getItemsNotShipped() {
		return itemsNotShipped;
	}

	public void setItemsNotShipped(Map<String, List<String>> itemsNotShipped) {
		this.itemsNotShipped = itemsNotShipped;
	}

	public OrderTranHeader getOrderInit() {
		return orderInit;
	}

	public void setOrderInit(OrderTranHeader orderInit) {
		this.orderInit = orderInit;
	}

	public OrderTranHeader getOrderPartial() {
		return orderPartial;
	}

	public void setOrderPartial(OrderTranHeader orderPartial) {
		this.orderPartial = orderPartial;
	}

	public OrderTranHeader getOrderCancel() {
		return orderCancel;
	}

	public void setOrderCancel(OrderTranHeader orderCancel) {
		this.orderCancel = orderCancel;
	}

	public String getPartialShippingReasonCode() {
		return partialShippingReasonCode;
	}

	public void setPartialShippingReasonCode(String partialShippingReasonCode) {
		this.partialShippingReasonCode = partialShippingReasonCode;
	}}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    